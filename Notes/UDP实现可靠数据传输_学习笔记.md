2017.10.11

## UDP实现可靠数据传输

1.为什么要使用UDP实现可靠数据传输，它和TCP相比有什么优势？

- 通过UDP来获取更快的响应速度（面向报文，无需建立连接）

## 实现分析

1. **前提**：如果基于UDP可以做的比TCP更好，那么一定是放弃了点TCP需要做到的东西但它也必须满足可靠传输所具备的特点：1.保证次序 2.不丢包。

2. **分析**：不允许信息丢失，但允许数据包乱序到达，基于这样的逻辑，接收方检测到数据包丢失会告知发送方重传，它的优势在于，即使中间有包晚到了，业务层也可以先拿到后面的包处理（一些播放器解码利用的就是这种思路），数据同样要保证有序，模仿TCP给它的数据包加seq即可，在业务层实现保证次序。

3. **为何这样做**？在网络状况不好的情况下，使用短连接相比较长连接能够获得更佳的用户体验，每个短连接对应不同的包，所以接收包的次序不重要，使用短连接的前提是发送数据包数据量较小（例如：DNS查询），而这正是TCP的弱项（三次连接+四次断连，比较占用网络资源），而UDP不存在这一点。

4. **实现思路**：在UDP协议之上，实现一个带超时的请求回应机制，让业务层负责超时重发，有可能取得比TCP通讯更好的效果。前提：单个请求或回应的包不应该过大，最好不要超过一个 MTU。

## 细节讨论

1. **数据包有序**：每个逻辑包都有一个16bit的序列号，从0开始编码，超过64k则回到0继续使用，关于优化，例：如果现在收到的序号为2，而下一个包的序号是FFFF，则认为seq为FFFF的包是seq为2的包的前三个，而不是向后一个很远的序号。（包可能是以{FFFF,0,1,2}顺序传来的，但到达主机的不一致，这里对其进行了优化）

2. **保证数据包全部到达**：不使用TCP那样的确认机制，而是采用请求机制，如果接收方有数据包丢失则请求发送方，发送方会尽可能保留已发出的数据（为了丢失重传），不过由于我们缺少了确认机制，发送方不会随意丢弃发出的数据，因此我们为发出的数据设置超时时间，如果超时则清理这些数据。

3. **keepalive**：在没有数据时，有可以维持心跳的空包，以及发生异常时通知对方异常的机制。

